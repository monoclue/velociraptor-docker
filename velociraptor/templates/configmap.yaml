apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "velociraptor.fullname" . }}
  labels:
    {{- include "velociraptor.labels" . | nindent 4 }}
data:
  entry.sh: |
          #!/bin/bash
          set -e
          cd /velociraptor
          echo "Step1"
          pwd
          ls -a
          cp /opt/velociraptor/linux/velociraptor . && chmod +x velociraptor
          mkdir -p $CLIENT_DIR/linux && rsync -a /opt/velociraptor/linux/velociraptor /velociraptor/clients/linux/velociraptor_client
          mkdir -p $CLIENT_DIR/mac && rsync -a /opt/velociraptor/mac/velociraptor_client /velociraptor/clients/mac/velociraptor_client
          mkdir -p $CLIENT_DIR/windows && rsync -a /opt/velociraptor/windows/velociraptor_client* /velociraptor/clients/windows/
          ./velociraptor config generate > server.config.yaml --merge '{"Frontend":{"public_path":"'{{ .Values.extraArgs.PUBLIC_PATH }}'", "hostname":"'{{ .Values.extraArgs.VELOX_FRONTEND_HOSTNAME }}'"}, "API":{"bind_address":"'{{ .Values.extraArgs.BIND_ADDRESS }}'"}, "GUI":{"bind_address":"'{{ .Values.extraArgs.BIND_ADDRESS }}'"}, "Monitoring":{"bind_address":"'{{ .Values.extraArgs.BIND_ADDRESS }}'"}, "Logging":{"output_directory":"'{{ .Values.extraArgs.LOG_DIR }}'", "separate_logs_per_component":"'{{ .Values.extraArgs.LOG_PER_COMPONENT }}'"}, "Client":{"server_urls":["'{{ .Values.extraArgs.VELOX_SERVER_URL }}'"], "use_self_signed_ssl":"'{{ .Values.extraArgs.SELF_SIGNED_CERT }}'"}, "Datastore":{"location":"'{{ .Values.extraArgs.DATASTORE_LOCATION }}'", "filestore_directory":"'{{ .Values.extraArgs.FILESTORE_DIRECTORY }}'"}}' &&\
          echo "Step2"
          ./velociraptor --config server.config.yaml user add {{ .Values.extraArgs.VELOX_USER }} {{ .Values.extraArgs.VELOX_PASSWORD }} --role administrator &&\
          echo "Step3"
          ./velociraptor --config server.config.yaml config client > client.config.yaml &&\
          echo "Step3"
          ./velociraptor config repack --exe clients/linux/velociraptor_client client.config.yaml clients/linux/velociraptor_client_repacked &&\
          echo "Step4"
          ./velociraptor config repack --exe clients/mac/velociraptor_client client.config.yaml clients/mac/velociraptor_client_repacked &&\
          echo "Step5"
          ./velociraptor config repack --exe clients/windows/velociraptor_client.exe client.config.yaml clients/windows/velociraptor_client_repacked.exe &&\
          echo "Step6"
          ./velociraptor --config server.config.yaml frontend -v